"""
Message formatting for Telegram notifications
"""

import logging
from typing import Dict, Any, Optional
from datetime import datetime
import json

logger = logging.getLogger(__name__)

class MessageFormatter:
    """Format trading signals and notifications for Telegram"""
    
    @staticmethod
    def format_trading_signal(signal_data: Dict[str, Any]) -> str:
        """Format trading signal for Telegram"""
        try:
            # Extract signal information
            signal_type = signal_data.get('signal', 'HOLD').upper()
            symbol = signal_data.get('symbol', 'UNKNOWN')
            price = signal_data.get('entry_price', 0)
            confidence = signal_data.get('confidence', 0)
            reasoning = signal_data.get('reasoning', 'No reasoning provided')
            stop_loss = signal_data.get('stop_loss')
            take_profit = signal_data.get('take_profit')
            risk_reward = signal_data.get('risk_reward_ratio', 0)
            timestamp = signal_data.get('timestamp', datetime.utcnow())
            
            # Format timestamp
            if isinstance(timestamp, str):
                timestamp = datetime.fromisoformat(timestamp.replace('Z', '+00:00'))
            time_str = timestamp.strftime('%Y-%m-%d %H:%M:%S UTC')
            
            # Signal emoji
            signal_emoji = {
                'BUY': 'ğŸŸ¢',
                'SELL': 'ğŸ”´', 
                'HOLD': 'ğŸŸ¡'
            }.get(signal_type, 'âšª')
            
            # Confidence emoji
            if confidence >= 80:
                confidence_emoji = 'ğŸ”¥'
            elif confidence >= 60:
                confidence_emoji = 'âš¡'
            else:
                confidence_emoji = 'âš ï¸'
            
            # Build message
            message = f"""
{signal_emoji} <b>[{signal_type}] {symbol}</b> {confidence_emoji}

ğŸ’° <b>Entry Price:</b> {price:.5f}
ğŸ“Š <b>Confidence:</b> {confidence}%
â° <b>Time:</b> {time_str}

<b>ğŸ“‹ Analysis:</b>
{reasoning}
"""
            
            # Add risk management if available
            if stop_loss and take_profit:
                message += f"""
ğŸ›¡ï¸ <b>Risk Management:</b>
â€¢ Stop Loss: {stop_loss:.5f}
â€¢ Take Profit: {take_profit:.5f}
â€¢ Risk/Reward: 1:{risk_reward:.2f}
"""
            
            # Add market structure info if available
            market_structure = signal_data.get('market_structure', {})
            if market_structure:
                message += f"\nğŸ—ï¸ <b>Market Structure:</b>\n"
                if market_structure.get('trend'):
                    message += f"â€¢ Trend: {market_structure['trend']}\n"
                if market_structure.get('key_levels'):
                    levels = market_structure['key_levels']
                    message += f"â€¢ Support: {levels.get('support', 'N/A')}\n"
                    message += f"â€¢ Resistance: {levels.get('resistance', 'N/A')}\n"
            
            # Add technical indicators summary
            indicators = signal_data.get('indicators_summary', {})
            if indicators:
                message += f"\nğŸ“ˆ <b>Key Indicators:</b>\n"
                for indicator, value in indicators.items():
                    if isinstance(value, (int, float)):
                        message += f"â€¢ {indicator}: {value:.2f}\n"
                    else:
                        message += f"â€¢ {indicator}: {value}\n"
            
            message += f"\n<i>Generated by Flask Trading System</i>"
            
            return message
            
        except Exception as e:
            logger.error(f"Error formatting trading signal: {str(e)}")
            return f"Error formatting signal for {signal_data.get('symbol', 'UNKNOWN')}"
    
    @staticmethod
    def format_performance_update(performance_data: Dict[str, Any]) -> str:
        """Format performance update for Telegram"""
        try:
            period = performance_data.get('period', '24h')
            win_rate = performance_data.get('win_rate', 0)
            total_signals = performance_data.get('total_signals', 0)
            total_pnl = performance_data.get('total_pnl', 0)
            best_pair = performance_data.get('best_performing_pair', 'N/A')
            
            pnl_emoji = 'ğŸ“ˆ' if total_pnl >= 0 else 'ğŸ“‰'
            
            message = f"""
ğŸ“Š <b>Performance Update ({period})</b>

{pnl_emoji} <b>Total P&L:</b> {total_pnl:+.2f}
ğŸ¯ <b>Win Rate:</b> {win_rate:.1f}%
ğŸ“¡ <b>Total Signals:</b> {total_signals}
ğŸ† <b>Best Pair:</b> {best_pair}

<i>Keep trading smart! ğŸ’ª</i>
"""
            
            return message
            
        except Exception as e:
            logger.error(f"Error formatting performance update: {str(e)}")
            return "Error formatting performance update"
    
    @staticmethod
    def format_market_alert(alert_data: Dict[str, Any]) -> str:
        """Format market alert for Telegram"""
        try:
            alert_type = alert_data.get('type', 'INFO')
            symbol = alert_data.get('symbol', 'MARKET')
            message_text = alert_data.get('message', 'Market alert')
            severity = alert_data.get('severity', 'medium')
            
            # Alert emoji based on type and severity
            alert_emojis = {
                'HIGH_VOLATILITY': 'âš¡',
                'BREAKOUT': 'ğŸš€',
                'REVERSAL': 'ğŸ”„',
                'NEWS': 'ğŸ“°',
                'ERROR': 'âŒ',
                'WARNING': 'âš ï¸',
                'INFO': 'â„¹ï¸'
            }
            
            severity_emojis = {
                'high': 'ğŸ”´',
                'medium': 'ğŸŸ¡',
                'low': 'ğŸŸ¢'
            }
            
            alert_emoji = alert_emojis.get(alert_type, 'â„¹ï¸')
            severity_emoji = severity_emojis.get(severity, 'ğŸŸ¡')
            
            message = f"""
{alert_emoji} <b>Market Alert</b> {severity_emoji}

ğŸ“ <b>Symbol:</b> {symbol}
ğŸ”” <b>Type:</b> {alert_type.replace('_', ' ').title()}

<b>Message:</b>
{message_text}

â° <b>Time:</b> {datetime.utcnow().strftime('%Y-%m-%d %H:%M:%S UTC')}
"""
            
            return message
            
        except Exception as e:
            logger.error(f"Error formatting market alert: {str(e)}")
            return "Error formatting market alert"
    
    @staticmethod
    def format_system_status(status_data: Dict[str, Any]) -> str:
        """Format system status update for Telegram"""
        try:
            status = status_data.get('status', 'UNKNOWN')
            uptime = status_data.get('uptime', 'N/A')
            active_pairs = status_data.get('active_pairs', [])
            last_signal = status_data.get('last_signal_time', 'N/A')
            api_status = status_data.get('api_status', {})
            
            status_emoji = {
                'ONLINE': 'ğŸŸ¢',
                'OFFLINE': 'ğŸ”´',
                'MAINTENANCE': 'ğŸŸ¡',
                'ERROR': 'âŒ'
            }.get(status, 'âšª')
            
            message = f"""
{status_emoji} <b>System Status: {status}</b>

â±ï¸ <b>Uptime:</b> {uptime}
ğŸ“Š <b>Active Pairs:</b> {len(active_pairs)}
ğŸ• <b>Last Signal:</b> {last_signal}

<b>ğŸ“¡ API Status:</b>
"""
            
            for api_name, api_status_info in api_status.items():
                api_emoji = 'ğŸŸ¢' if api_status_info.get('status') == 'OK' else 'ğŸ”´'
                message += f"â€¢ {api_name}: {api_emoji} {api_status_info.get('status', 'UNKNOWN')}\n"
            
            if active_pairs:
                message += f"\n<b>ğŸ¯ Monitoring:</b> {', '.join(active_pairs[:5])}"
                if len(active_pairs) > 5:
                    message += f" (+{len(active_pairs) - 5} more)"
            
            return message
            
        except Exception as e:
            logger.error(f"Error formatting system status: {str(e)}")
            return "Error formatting system status"
    
    @staticmethod
    def format_error_notification(error_data: Dict[str, Any]) -> str:
        """Format error notification for Telegram"""
        try:
            error_type = error_data.get('type', 'UNKNOWN_ERROR')
            error_message = error_data.get('message', 'An error occurred')
            component = error_data.get('component', 'System')
            timestamp = error_data.get('timestamp', datetime.utcnow())
            
            if isinstance(timestamp, str):
                timestamp = datetime.fromisoformat(timestamp.replace('Z', '+00:00'))
            time_str = timestamp.strftime('%Y-%m-%d %H:%M:%S UTC')
            
            message = f"""
âŒ <b>System Error Alert</b>

ğŸ”§ <b>Component:</b> {component}
âš ï¸ <b>Error Type:</b> {error_type}
â° <b>Time:</b> {time_str}

<b>Details:</b>
{error_message}

<i>Please check system logs for more information.</i>
"""
            
            return message
            
        except Exception as e:
            logger.error(f"Error formatting error notification: {str(e)}")
            return f"Critical error in notification system: {str(e)}"
